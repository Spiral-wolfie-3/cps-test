<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate CPS Test</title>
<style>
    body { font-family: sans-serif; text-align: center; background: #f8f8f8; color: #000; margin: 0; transition: background 0.3s, color 0.3s; }
    h1 { margin-top: 40px; }
    .button { display: inline-block; margin: 10px; padding: 15px 30px; background: #ccc; border-radius: 10px; cursor: pointer; user-select: none; transition: background 0.3s, color 0.3s; }
    .button:hover { background: #aaf; }
    #leaderboards { display: none; margin-top: 20px; }
    #results { display: none; margin-top: 20px; }
    #test-area { display: none; margin-top: 40px; padding: 40px; background: #eee; cursor: pointer; user-select: none; border-radius: 12px; }

    /* Table styling */
    table { 
        margin: 10px auto; 
        border-collapse: collapse; 
        width: 90%; 
        max-width: 500px;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        transition: background 0.3s, color 0.3s;
    }

    th, td { 
        border: 1px solid #aaa; 
        padding: 8px 12px; 
        text-align: center; 
        transition: background 0.3s, color 0.3s;
    }

    th { 
        background: #88f; 
        color: #fff; 
    }

    tr:nth-child(even) td { 
        background: #f2f2f2; 
    }

    /* Top 3 rank styles */
    tr.rank-1 { background-color: #ffeb3b; color: #000; font-weight: bold; animation: glow 1s infinite alternate; }
    tr.rank-2 { background-color: #C0C0C0; color: #000; font-weight: bold; }
    tr.rank-3 { background-color: #CD7F32; color: #fff; font-weight: bold; }

    /* Glow animation */
    @keyframes glow {
        from { background-color: #ffeb3b; }
        to { background-color: #ffd700; }
    }

    /* Dark mode */
    body.dark { background: #121212; color: #fff; }
    body.dark .button { background: #333; color: #fff; }
    body.dark .button:hover { background: #555; }
    body.dark table { background: #1f1f1f; color: #fff; }
    body.dark th { background: #444; color: #fff; }
    body.dark tr:nth-child(even) td { background: #2a2a2a; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB3SSl9d9Qj7WPg24GWqcRLNObVSbFPqB0",
    authDomain: "wolfies-cps-test.firebaseapp.com",
    projectId: "wolfies-cps-test",
    storageBucket: "wolfies-cps-test.firebasestorage.app",
    messagingSenderId: "534484408750",
    appId: "1:534484408750:web:03fb95ab59dc8f1902d03f",
    databaseURL: "https://wolfies-cps-test-default-rtdb.firebaseio.com"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>
</head>
<body>

<h1>Ultimate CPS Test</h1>

<div id="main-menu">
    <div>
        <label for="playerName">Enter your name: </label>
        <input type="text" id="playerName" maxlength="12" placeholder="Player">
    </div>
    <div style="margin-top: 20px;">
        <div class="button" data-time="1">1s Test</div>
        <div class="button" data-time="5">5s Test</div>
        <div class="button" data-time="10">10s Test</div>
        <div class="button" id="show-leaderboards">Leaderboards</div>
        <div class="button" id="toggle-dark">Dark Mode</div>
    </div>
</div>

<div id="test-area">
    <h2 id="timer">Time: 0.00</h2>
    <h2 id="clicks">Clicks: 0</h2>
    <p>Click anywhere in this box!</p>
</div>

<div id="results">
    <h2>Finished!</h2>
    <h3 id="result-cps"></h3>
    <h3 id="result-style"></h3>
    <div class="button" id="back-main">Back to Menu</div>
</div>

<div id="leaderboards">
    <h2>Leaderboards</h2>
    <div>
        <div class="button" id="refresh-leaderboards">Refresh Leaderboard</div>
    </div>
    <div id="boards"></div>
    <div class="button" id="back-menu">Back to Menu</div>
</div>

<script>
let playerNameInput = document.getElementById("playerName");
let mainMenu = document.getElementById("main-menu");
let testArea = document.getElementById("test-area");
let resultsScreen = document.getElementById("results");
let leaderboardsScreen = document.getElementById("leaderboards");

let timerEl = document.getElementById("timer");
let clicksEl = document.getElementById("clicks");
let resultCpsEl = document.getElementById("result-cps");
let resultStyleEl = document.getElementById("result-style");
let boardsEl = document.getElementById("boards");

let testTime = 0;
let clicks = 0;
let startTime = 0;
let clickTimes = [];
let running = false;

const AUTCLICK_THRESHOLDS = { 1: 40 };

function showMenu() {
    mainMenu.style.display = "block";
    testArea.style.display = "none";
    resultsScreen.style.display = "none";
    leaderboardsScreen.style.display = "none";
}

function showTest() {
    mainMenu.style.display = "none";
    testArea.style.display = "block";
    resultsScreen.style.display = "none";
    leaderboardsScreen.style.display = "none";
    clicks = 0;
    clickTimes = [];
    startTime = 0;
    running = true;
    timerEl.innerText = `Time: ${testTime.toFixed(2)}`;
    clicksEl.innerText = `Clicks: 0`;
}

function detectClickStyle(times) {
    if(times.length < 6) return "Normal Clicking";
    let intervals = [];
    for(let i = 1; i < times.length; i++) intervals.push(times[i] - times[i-1]);
    let avg = intervals.reduce((a,b)=>a+b,0) / intervals.length;
    if(avg < 0.08) return "Butterfly / Jitter Clicking";
    if(avg < 0.12) return "Fast Clicking";
    return "Normal Clicking";
}

function isConsistentClicking(times) {
    if (times.length < 15) return false;
    let intervals = [];
    for (let i = 1; i < times.length; i++) intervals.push(times[i] - times[i - 1]);
    let avg = intervals.reduce((a, b) => a + b, 0) / intervals.length;
    let variance = intervals.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / intervals.length;
    let stdDev = Math.sqrt(variance);
    return stdDev < 0.01;
}

// ---------- Firebase Leaderboard Functions ----------
function addScoreToFirebase(time, name, cps, isAuto=false) {
    const refName = isAuto ? 'autoclickers' : `leaderboards/${time}`;
    db.ref(refName).push({ name, cps, time });
}

function fetchLeaderboards(callback) {
    const refs = ['leaderboards/1','leaderboards/5','leaderboards/10','autoclickers'];
    let results = {1:[],5:[],10:[], autoclickers:[]};
    let loaded = 0;

    refs.forEach(path => {
        db.ref(path).once('value', snapshot => {
            snapshot.forEach(child => {
                const val = child.val();
                if(path.includes('autoclickers')) results.autoclickers.push(val);
                else results[parseInt(path.split('/')[1])].push(val);
            });
            loaded++;
            if(loaded === refs.length) callback(results);
        });
    });
}

function showResults(cps, style, isAuto) {
    mainMenu.style.display = "none";
    testArea.style.display = "none";
    resultsScreen.style.display = "block";
    leaderboardsScreen.style.display = "none";
    resultCpsEl.innerText = `CPS: ${cps.toFixed(2)} ${isAuto ? "(Autoclicker!)" : ""}`;
    resultStyleEl.innerText = isAuto ? "AUTOCLICKER DETECTED" : style;
}

// ---------- Leaderboards ----------
function renderLeaderboards(data) {
    boardsEl.innerHTML = "";
    for(let t of [1,5,10]) {
        let table = document.createElement("table");
        let html = `<tr><th colspan="3">${t}s Top CPS</th></tr>`;
        html += `<tr><th>Rank</th><th>Name</th><th>CPS</th></tr>`;
        data[t].sort((a,b)=>b.cps-a.cps);
        data[t].slice(0,5).forEach((e,i)=>{
            let rankClass = '';
            if(i===0) rankClass='rank-1';
            else if(i===1) rankClass='rank-2';
            else if(i===2) rankClass='rank-3';
            html += `<tr class="${rankClass}"><td>${i+1}</td><td>${e.name}</td><td>${e.cps.toFixed(2)}</td></tr>`;
        });
        table.innerHTML = html;
        boardsEl.appendChild(table);
    }

    // Autoclickers table
    let acTable = document.createElement("table");
    let html = `<tr><th colspan="3">Autoclickers</th></tr>`;
    html += `<tr><th>Rank</th><th>Name</th><th>CPS (Mode)</th></tr>`;
    data.autoclickers.sort((a,b)=>b.cps-a.cps);
    data.autoclickers.slice(0,5).forEach((e,i)=>{
        let rankClass = '';
        if(i===0) rankClass='rank-1';
        else if(i===1) rankClass='rank-2';
        else if(i===2) rankClass='rank-3';
        html += `<tr class="${rankClass}"><td>${i+1}</td><td>${e.name}</td><td>${e.cps.toFixed(2)} (${e.time}s)</td></tr>`;
    });
    acTable.innerHTML = html;
    boardsEl.appendChild(acTable);
}

function showLeaderboards() {
    leaderboardsScreen.style.display = "block";
    mainMenu.style.display = "none";
    testArea.style.display = "none";
    resultsScreen.style.display = "none";
    boardsEl.innerHTML = "Loading...";
    fetchLeaderboards(renderLeaderboards);
}

// ---------- Test Logic ----------
document.querySelectorAll(".button[data-time]").forEach(btn=>{
    btn.onclick = () => {
        testTime = parseInt(btn.dataset.time);
        if(!playerNameInput.value.trim()) playerNameInput.value = "Player";
        showTest();
    }
});

testArea.onmousedown = () => {
    if(!running) return;
    let now = performance.now() / 1000;
    if(startTime === 0) startTime = now;
    clicks++;
    clickTimes.push(now);
    clicksEl.innerText = `Clicks: ${clicks}`;
};

setInterval(()=>{
    if(running && startTime > 0) {
        let elapsed = performance.now()/1000 - startTime;
        let remaining = Math.max(0, testTime - elapsed);
        timerEl.innerText = `Time: ${remaining.toFixed(2)}`;

        if(elapsed >= testTime) {
            running = false;
            let cps = clicks / testTime;
            let style = detectClickStyle(clickTimes);
            let name = playerNameInput.value;

            let isAuto = false;
            if (testTime === 1) {
                isAuto = cps > AUTCLICK_THRESHOLDS[1];
            } else {
                isAuto = isConsistentClicking(clickTimes);
            }

            addScoreToFirebase(testTime, name, cps, isAuto);
            showResults(cps, style, isAuto);
        }
    }
}, 50);

// ---------- Menu Buttons ----------
document.getElementById("back-main").onclick = showMenu;
document.getElementById("back-menu").onclick = showMenu;
document.getElementById("show-leaderboards").onclick = showLeaderboards;
document.getElementById("refresh-leaderboards").onclick = ()=> fetchLeaderboards(renderLeaderboards);
document.getElementById("toggle-dark").onclick = ()=>{
    document.body.classList.toggle("dark");
};

showMenu();
</script>
</body>
</html>

