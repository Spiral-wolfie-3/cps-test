<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate CPS Test</title>
<style>
    body { font-family: sans-serif; text-align: center; background: #f8f8f8; color: #000; margin: 0; transition: background 0.3s, color 0.3s; }
    h1 { margin-top: 40px; }
    .button { display: inline-block; margin: 10px; padding: 15px 30px; background: #ccc; border-radius: 10px; cursor: pointer; user-select: none; transition: background 0.3s, color 0.3s; }
    .button:hover { background: #aaf; }
    #leaderboards, #achievements { display: none; margin-top: 20px; }
    #test-area { display: none; margin-top: 40px; padding: 40px; background: #eee; cursor: pointer; user-select: none; border-radius: 12px; position: relative; overflow: hidden; }

    /* Click animation */
    .click-circle {
        position: absolute;
        width: 20px; height: 20px;
        border-radius: 50%;
        background: rgba(255, 100, 0, 0.7);
        transform: translate(-50%, -50%);
        pointer-events: none;
        animation: click-pop 0.5s forwards;
    }
    @keyframes click-pop { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }

    /* Table styling */
    table { margin: 10px auto; border-collapse: collapse; width: 90%; max-width: 500px; background: #fff; border-radius: 8px; overflow: hidden; transition: background 0.3s, color 0.3s; }
    th, td { border: 1px solid #aaa; padding: 8px 12px; text-align: center; transition: background 0.3s, color 0.3s; }
    th { background: #88f; color: #fff; }
    tr:nth-child(even) td { background: #f2f2f2; }
    tr.rank-1 { background-color: #ffeb3b; color: #000; font-weight: bold; animation: glow 1s infinite alternate; }
    tr.rank-2 { background-color: #C0C0C0; color: #000; font-weight: bold; }
    tr.rank-3 { background-color: #CD7F32; color: #fff; font-weight: bold; }
    @keyframes glow { from { background-color: #ffeb3b; } to { background-color: #ffd700; } }

    /* Dark mode */
    body.dark { background: #121212; color: #fff; }
    body.dark .button { background: #333; color: #fff; }
    body.dark .button:hover { background: #555; }
    body.dark table { background: #1f1f1f; color: #fff; }
    body.dark th { background: #444; color: #fff; }
    body.dark tr.rank-2 td { color: #000; background-color: #C0C0C0; }
    body.dark tr:not(.rank-1):not(.rank-2):not(.rank-3):nth-child(even) td { background: #2a2a2a; color: #fff; }
    body.dark tr:not(.rank-1):not(.rank-2):not(.rank-3):nth-child(odd) td { background: #1f1f1f; color: #fff; }

    /* Achievements */
    #achievements ul { list-style: none; padding: 0; max-width: 500px; margin: auto; }
    #achievements li { background: #88f; color: #fff; margin: 5px 0; padding: 10px; border-radius: 6px; transition: background 0.3s, color 0.3s; }
    body.dark #achievements li { background: #333; color: #fff; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyB3SSl9d9Qj7WPg24GWqcRLNObVSbFPqB0",
    authDomain: "wolfies-cps-test.firebaseapp.com",
    projectId: "wolfies-cps-test",
    storageBucket: "wolfies-cps-test.firebasestorage.app",
    messagingSenderId: "534484408750",
    appId: "1:534484408750:web:03fb95ab59dc8f1902d03f",
    databaseURL: "https://wolfies-cps-test-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<body>

<canvas id="firework-canvas" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999;"></canvas>

<h1>Ultimate CPS Test</h1>

<div id="main-menu">
    <div>
        <label for="playerName">Enter your name: </label>
        <input type="text" id="playerName" maxlength="12" placeholder="Player">
    </div>
    <div style="margin-top: 20px;">
        <div class="button" data-time="1">1s Test</div>
        <div class="button" data-time="5">5s Test</div>
        <div class="button" data-time="10">10s Test</div>
        <div class="button" id="show-leaderboards">Leaderboards</div>
        <div class="button" id="show-achievements">Achievements</div>
        <div class="button" id="toggle-dark">Dark Mode</div>
    </div>
</div>

<div id="test-area">
    <h2 id="timer">Time: 0.00</h2>
    <h2 id="clicks">Clicks: 0</h2>
    <p>Click anywhere in this box!</p>
</div>

<div id="results">
    <h2>Finished!</h2>
    <h3 id="result-cps"></h3>
    <h3 id="result-style"></h3>
    <div class="button" id="back-main">Back to Menu</div>
</div>

<div id="leaderboards">
    <h2>Leaderboards</h2>
    <div>
        <div class="button" id="refresh-leaderboards">Refresh Leaderboard</div>
    </div>
    <div id="boards"></div>
    <div class="button" id="back-menu">Back to Menu</div>
</div>

<div id="achievements">
    <h2>Achievements</h2>
    <ul id="achieve-list"></ul>
    <div class="button" id="back-achievements">Back to Menu</div>
</div>

<script>
let playerNameInput=document.getElementById("playerName");
let mainMenu=document.getElementById("main-menu");
let testArea=document.getElementById("test-area");
let resultsScreen=document.getElementById("results");
let leaderboardsScreen=document.getElementById("leaderboards");
let achievementsScreen=document.getElementById("achievements");
let timerEl=document.getElementById("timer");
let clicksEl=document.getElementById("clicks");
let resultCpsEl=document.getElementById("result-cps");
let resultStyleEl=document.getElementById("result-style");
let boardsEl=document.getElementById("boards");
let achieveList=document.getElementById("achieve-list");

let testTime=0, clicks=0, startTime=0, clickTimes=[], running=false;
const AUTCLICK_THRESHOLDS={1:40};
let achievements={};

// ---------- Fireworks ----------
const canvas=document.getElementById("firework-canvas");
const ctx=canvas.getContext("2d");
let particles=[];
function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
window.addEventListener('resize',resizeCanvas);
resizeCanvas();
function createFireworkAt(x,y){
    for(let i=0;i<30;i++){
        let angle=Math.random()*2*Math.PI;
        let speed=Math.random()*3+2;
        particles.push({x:x, y:y, vx:Math.cos(angle)*speed, vy:Math.sin(angle)*speed, alpha:1, color:`hsl(${Math.random()*360},100%,50%)`});
    }
}
function animateFireworks(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particles.forEach(p=>{
        ctx.fillStyle=p.color;
        ctx.globalAlpha=p.alpha;
        ctx.beginPath();
        ctx.arc(p.x,p.y,3,0,2*Math.PI);
        ctx.fill();
        p.x+=p.vx;
        p.y+=p.vy;
        p.alpha-=0.02;
    });
    particles=particles.filter(p=>p.alpha>0);
    requestAnimationFrame(animateFireworks);
}
animateFireworks();

// ---------- Menu ----------
function showMenu(){ mainMenu.style.display="block"; testArea.style.display="none"; resultsScreen.style.display="none"; leaderboardsScreen.style.display="none"; achievementsScreen.style.display="none"; }
function showTest(){ mainMenu.style.display="none"; testArea.style.display="block"; resultsScreen.style.display="none"; leaderboardsScreen.style.display="none"; achievementsScreen.style.display="none"; clicks=0; clickTimes=[]; startTime=0; running=true; timerEl.innerText=`Time: ${testTime.toFixed(2)}`; clicksEl.innerText=`Clicks: 0`; }
function showResults(cps,style,isAuto){ mainMenu.style.display="none"; testArea.style.display="none"; resultsScreen.style.display="block"; leaderboardsScreen.style.display="none"; achievementsScreen.style.display="none"; resultCpsEl.innerText=`CPS: ${cps.toFixed(2)} ${isAuto?"(Autoclicker!)":""}`; resultStyleEl.innerText=isAuto?"AUTOCLICKER DETECTED":style; }

// ---------- Firebase ----------
function addScoreToFirebase(time,name,cps,isAuto=false){ const refName=isAuto?'autoclickers':`leaderboards/${time}`; db.ref(refName).push({name,cps,time}); }
function fetchLeaderboards(callback){
    let results={1:[],5:[],10:[],autoclickers:[]},loaded=0;
    ['leaderboards/1','leaderboards/5','leaderboards/10','autoclickers'].forEach(path=>{
        db.ref(path).once('value',snapshot=>{
            snapshot.forEach(child=>{
                const val=child.val();
                path.includes('autoclickers')?results.autoclickers.push(val):results[parseInt(path.split('/')[1])].push(val);
            });
            loaded++; if(loaded===4) callback(results);
        });
    });
}

// ---------- Achievements ----------
const achievementDefs = [
    {name:"First Blood", check: (data,pos)=>pos<=5},
    {name:"Champion", check:(data,pos)=>pos===1},
    {name:"Silver Touch", check:(data,pos)=>pos===2},
    {name:"Bronze Hero", check:(data,pos)=>pos===3},
    {name:"Podium Master", check:(data,pos,dataT)=>dataT && dataT.length>=3 && dataT[0].name===playerNameInput.value && dataT[1].name===playerNameInput.value && dataT[2].name===playerNameInput.value},
    {name:"All-Time King", check:(data)=>[1,5,10].every(t=>data[t].some(e=>e.name===playerNameInput.value && e.cps>=data[t][0].cps))},
    {name:"All-Time Silver", check:(data)=>[1,5,10].every(t=>data[t].some(e=>e.name===playerNameInput.value && e.cps>=data[t][1]?.cps||0))},
    {name:"Click Novice", check:(cps)=>cps>=10},
    {name:"Click Pro", check:(cps)=>cps>=15},
    {name:"Click God", check:(cps)=>cps>=20},
    {name:"Click Legend", check:(cps)=>cps>=50},
];

function checkAchievements(data,cps){
    achievementDefs.forEach(a=>{
        if(!achievements[a.name]){
            let unlocked=false;
            if(a.check.length===1) unlocked=a.check(cps);
            else unlocked=a.check(data);
            if(unlocked){ achievements[a.name]=true; alert(`Achievement Unlocked: ${a.name}! ðŸŽ‰`); }
        }
    });
}

function showAchievements(){ achievementsScreen.style.display="block"; mainMenu.style.display="none"; testArea.style.display="none"; resultsScreen.style.display="none"; leaderboardsScreen.style.display="none"; updateAchievementsUI(); }
function updateAchievementsUI(){
    achieveList.innerHTML="";
    Object.keys(achievements).forEach(a=>{
        achieveList.innerHTML+=`<li>${a}</li>`;
    });
}

// ---------- Render Leaderboards ----------
function renderLeaderboards(data){
    boardsEl.innerHTML="";
    [1,5,10].forEach(t=>{
        let table=document.createElement("table");
        let html=`<tr><th colspan="3">${t}s Top CPS</th></tr><tr><th>Rank</th><th>Name</th><th>CPS</th></tr>`;
        data[t].sort((a,b)=>b.cps-a.cps).slice(0,5).forEach((e,i)=>{
            let rankClass=i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
            html+=`<tr class="${rankClass}"><td>${i+1}</td><td>${e.name}</td><td>${e.cps.toFixed(2)}</td></tr>`;
        });
        table.innerHTML=html;
        boardsEl.appendChild(table);

        // Fireworks above #1
        let rank1Row = table.querySelector('.rank-1');
        if(rank1Row){
            let rect=rank1Row.getBoundingClientRect();
            createFireworkAt(rect.left+rect.width/2, rect.top+rect.height/2);
        }
    });

    // Autoclickers table
    let acTable=document.createElement("table");
    let html=`<tr><th colspan="3">Autoclickers</th></tr><tr><th>Rank</th><th>Name</th><th>CPS (Mode)</th></tr>`;
    data.autoclickers.sort((a,b)=>b.cps-a.cps).slice(0,5).forEach((e,i)=>{
        let rankClass=i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
        html+=`<tr class="${rankClass}"><td>${i+1}</td><td>${e.name}</td><td>${e.cps.toFixed(2)} (${e.time}s)</td></tr>`;
    });
    acTable.innerHTML=html;
    boardsEl.appendChild(acTable);

    checkAchievements(data,clicks/testTime);
}

// ---------- Test Logic ----------
document.querySelectorAll(".button[data-time]").forEach(btn=>btn.onclick=()=>{
    testTime=parseInt(btn.dataset.time);
    if(!playerNameInput.value.trim()) playerNameInput.value="Player";
    showTest();
});

testArea.onmousedown=e=>{
    if(!running) return;
    let now=performance.now()/1000;
    if(startTime===0) startTime=now;
    clicks++; clickTimes.push(now);
    clicksEl.innerText=`Clicks: ${clicks}`;

    // Click animation
    const rect=testArea.getBoundingClientRect();
    let x=e.clientX-rect.left;
    let y=e.clientY-rect.top;
    let circle=document.createElement("div");
    circle.className="click-circle";
    circle.style.left=x+"px";
    circle.style.top=y+"px";
    testArea.appendChild(circle);
    setTimeout(()=>circle.remove(),500);
};

setInterval(()=>{
    if(running && startTime>0){
        let elapsed=performance.now()/1000-startTime;
        let remaining=Math.max(0,testTime-elapsed);
        timerEl.innerText=`Time: ${remaining.toFixed(2)}`;
        if(elapsed>=testTime){
            running=false;
            let cps=clicks/testTime;
            let style=detectClickStyle(clickTimes);
            let name=playerNameInput.value;
            let isAuto=testTime===1?cps>AUTCLICK_THRESHOLDS[1]:isConsistentClicking(clickTimes);
            addScoreToFirebase(testTime,name,cps,isAuto);
            showResults(cps,style,isAuto);
        }
    }
},50);

// ---------- Buttons ----------
document.getElementById("back-main").onclick=showMenu;
document.getElementById("back-menu").onclick=showMenu;
document.getElementById("refresh-leaderboards").onclick=()=>fetchLeaderboards(renderLeaderboards);
document.getElementById("toggle-dark").onclick=()=>document.body.classList.toggle("dark");
document.getElementById("show-leaderboards").onclick=()=>{ leaderboardsScreen.style.display="block"; mainMenu.style.display="none"; testArea.style.display="none"; resultsScreen.style.display="none"; fetchLeaderboards(renderLeaderboards); };
document.getElementById("show-achievements").onclick=showAchievements;
document.getElementById("back-achievements").onclick=showMenu;

// ---------- Click anywhere on results to return to menu ----------
resultsScreen.addEventListener("click", () => {
    if (!running && resultsScreen.style.display === "block") {
        showMenu();
    }
});

showMenu();
</script>
</body>
</html>

